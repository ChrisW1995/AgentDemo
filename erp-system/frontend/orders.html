<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理 - ERP System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-completed { background-color: #28a745; color: white; }
        .status-cancelled { background-color: #dc3545; color: white; }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-arrow-left-circle"></i> 返回主页
            </a>
            <span class="navbar-text text-white">
                <i class="bi bi-cart-check-fill"></i> 订单管理
            </span>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-plus-circle"></i> 创建新订单</h5>
                    </div>
                    <div class="card-body">
                        <form id="createOrderForm">
                            <div class="mb-3">
                                <label class="form-label">客户名称</label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">选择产品</label>
                                <select class="form-select" id="productSelect">
                                    <option value="">选择产品...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-control" id="quantity" min="1" value="1">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addOrderItem()">
                                <i class="bi bi-plus"></i> 添加到订单
                            </button>
                            <hr>
                            <div id="orderItems" class="mb-3">
                                <strong>订单项：</strong>
                                <ul id="orderItemsList" class="list-unstyled mt-2"></ul>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-check-circle"></i> 创建订单
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-list-check"></i> 订单列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>客户名称</th>
                                        <th>订单日期</th>
                                        <th>总金额</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let products = [];
        let orderItems = [];

        // 加载产品列表
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                products = await response.json();
                const select = document.getElementById('productSelect');
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ¥${product.price} (库存: ${product.stock_quantity})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('加载产品失败:', error);
            }
        }

        // 添加订单项
        function addOrderItem() {
            const productId = parseInt(document.getElementById('productSelect').value);
            const quantity = parseInt(document.getElementById('quantity').value);

            if (!productId || !quantity) {
                alert('请选择产品和数量');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            orderItems.push({ product_id: productId, quantity: quantity, product_name: product.name });
            updateOrderItemsList();
        }

        // 更新订单项列表
        function updateOrderItemsList() {
            const list = document.getElementById('orderItemsList');
            list.innerHTML = '';
            orderItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'mb-1';
                li.innerHTML = `
                    ${item.product_name} x ${item.quantity}
                    <button class="btn btn-sm btn-danger" onclick="removeOrderItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                list.appendChild(li);
            });
        }

        // 移除订单项
        function removeOrderItem(index) {
            orderItems.splice(index, 1);
            updateOrderItemsList();
        }

        // 创建订单
        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (orderItems.length === 0) {
                alert('请至少添加一个订单项');
                return;
            }

            const orderData = {
                customer_name: document.getElementById('customerName').value,
                items: orderItems
            };

            try {
                const response = await fetch(`${API_BASE}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    alert('订单创建成功！');
                    document.getElementById('createOrderForm').reset();
                    orderItems = [];
                    updateOrderItemsList();
                    loadOrders();
                } else {
                    const error = await response.json();
                    alert('创建失败: ' + error.detail);
                }
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        });

        // 加载订单列表
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders`);
                const orders = await response.json();
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = '';

                orders.reverse().forEach(order => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${order.customer_name}</td>
                        <td>${new Date(order.order_date).toLocaleDateString('zh-CN')}</td>
                        <td>¥${order.total_amount.toFixed(2)}</td>
                        <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showOrderDetail(${order.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'completed')" ${order.status !== 'pending' ? 'disabled' : ''}>
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="updateOrderStatus(${order.id}, 'cancelled')" ${order.status !== 'pending' ? 'disabled' : ''}>
                                <i class="bi bi-x"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载订单失败:', error);
            }
        }

        // 更新订单状态
        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (response.ok) {
                    alert('状态更新成功！');
                    loadOrders();
                } else {
                    alert('更新失败');
                }
            } catch (error) {
                alert('更新失败: ' + error.message);
            }
        }

        // 显示订单详情
        async function showOrderDetail(orderId) {
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}`);
                const order = await response.json();

                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td>${item.product.name}</td>
                            <td>${item.quantity}</td>
                            <td>¥${item.unit_price.toFixed(2)}</td>
                            <td>¥${item.subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                document.getElementById('orderDetailBody').innerHTML = `
                    <div><strong>订单号:</strong> #${order.id}</div>
                    <div><strong>客户名称:</strong> ${order.customer_name}</div>
                    <div><strong>订单日期:</strong> ${new Date(order.order_date).toLocaleString('zh-CN')}</div>
                    <div><strong>状态:</strong> <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></div>
                    <hr>
                    <h6>订单项:</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>产品</th>
                                <th>数量</th>
                                <th>单价</th>
                                <th>小计</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="text-end"><strong>总金额: ¥${order.total_amount.toFixed(2)}</strong></div>
                `;

                new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
            } catch (error) {
                alert('加载详情失败: ' + error.message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待处理',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return statusMap[status] || status;
        }

        // 初始化
        loadProducts();
        loadOrders();
    </script>
</body>
</html>
